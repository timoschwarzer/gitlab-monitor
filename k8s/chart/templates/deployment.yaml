apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.eurekaName | default (include "app.name" .) }}
  namespace: sequoia
  annotations:
    deploymentExpirationTime: "0"
spec:
  selector:
    matchLabels:
      app: {{ .Values.eurekaName | default (include "app.name" .) }}
  replicas: {{ .Values.replicaCount }}
  template:
    metadata:
      annotations:
        buildID: {{ .Values.buildID }}
        prometheus.io/scrape: "true"
        prometheus.io/port: "80"
      labels:
        app: {{ .Values.eurekaName | default (include "app.name" .) }}
        owner: {{ .Values.owner }}
    spec:
      containers:
      - name: {{ .Values.eurekaName | default (include "app.name" .) }}
        image: {{required "Image tag is required:  helm template --set image.tag=" .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        - name: COMMIT_HASH
          value: {{ .Values.commitHash }}
        - name: SGK_APP
          value: {{ .Values.eurekaName | default (include "app.name" .) }}
        - name: PORT
          value: "80"
        - name: GITLAB_MONITOR_CONFIG
          value: | {{ .Values.config | trim | nindent 12 }}
        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: sequoia
              key: environment
        ports:
        - containerPort: {{ .Values.internalPort }}
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 120
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 128Mi
      - name: sidecar
        image: artifactory.acorn.cirrostratus.org/cypress/sidecar-light:latest
        imagePullPolicy: Always
        command: ["/opt/start.sh"]
        args: [$(REGISTRATION)]
        resources:
          limits:
            cpu: 1500m
            memory: 1.5Gi
          requests:
            cpu: .5
            memory: 1.5Gi
        ports:
          - containerPort: 8888
        env:
          - name: REGISTRATION
            value: "{% if serviceLocatable %}--registration-enabled{% endif %}"
          - name: HOSTNAME
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: APP_CONT_ID
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: EKS_ENVIRONMENT
            valueFrom:
              configMapKeyRef:
                name: sequoia
                key: environment
          - name: SGK_ENVIRONMENT
            valueFrom:
              configMapKeyRef:
                name: sequoia
                key: environment
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: SGK_DEPLOY_ID
            valueFrom:
              fieldRef:
                fieldPath: metadata.uid
          - name: SGK_INSTANCE_ID
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: HOST_IP_ADDRESS
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: SGK_BASE_DOMAIN
            valueFrom:
              configMapKeyRef:
                name: sequoia
                key: basedomain
          - name: SGK_HEALTHCHECK_URI
            value: "/"
          - name: DEBUG
            value: "False"
          - name: SGK_EUREKA_NON_SECURE_PORT
            value: "80"
          - name: SGK_APP
            value: {{ .Values.eurekaName | default (.Values.app.name) }}
          - name: AWS_DEFAULT_REGION
            value: "us-east-1"
      - name: eureka-mark-up
        image: artifactory.acorn.cirrostratus.org/cypress/uppy:latest
        imagePullPolicy: Always
        command: ["/usr/bin/startup.sh"]
        args: []
        resources:
          limits:
            cpu: "0.5"
            memory: "500Mi"
          requests:
            cpu: "0.25"
            memory: "180Mi"
        env:
          - name: SGK_DEPLOY_ID
            valueFrom:
              fieldRef:
                fieldPath: metadata.uid
          - name: SGK_INSTANCE_ID
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: HOSTNAME
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: APP_CONT_ID
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: EKS_ENVIRONMENT
            valueFrom:
              configMapKeyRef:
                name: sequoia
                key: environment
          - name: SGK_ENVIRONMENT
            valueFrom:
              configMapKeyRef:
                name: sequoia
                key: environment
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: HOST_IP_ADDRESS
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: SGK_BASE_DOMAIN
            valueFrom:
              configMapKeyRef:
                name: sequoia
                key: basedomain
          - name: SGK_APP
            value: {{ .Values.eurekaName | default (.Values.app.name) }}
          - name: SGK_HEALTHCHECK_URI
            value: "/"
          - name: SGK_EUREKA_NON_SECURE_PORT
            value: "80"
          - name: SIDECAR_PORT
            value: "8888"
          - name: AWS_DEFAULT_REGION
            value: "us-east-1"
